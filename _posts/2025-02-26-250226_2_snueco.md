---
layout: single
title:  "[8] 계단업 로직 설명"
toc: true
toc_sticky: true
toc_label: "페이지 주요 목차"
---

# 계단업 기능 및 로직 소개  
계단업 기능을 위해 하루에 얼마나/한 달에 얼마나 계단을 오르고 내렸는가를 기록하고, 이를 통해 얼만큼의 CO2-eq를 저감하였는가를 나타내는 것을 목표로 함.  
사용하는 로직의 목표는 '사용자가 계단을 의도한 방식으로 오르고 내렸는가?'를 판별함.  
이 글에서는 로직에서 사용하는 주요 판단 기준과 기준 충족 여부를 판단하는 코드를 설명하겠음.  

### 로직에서 사용하는 컬렉션 별 필드
|컬렉션 명|필드 이름|설명|
|:---:|:---:|:---:|
|users|uid|유저별 고유 번호 (user-id)|
||log_bottle|계단을 오를 때 로그 기록 (어플 내 오른 계단 수 확인에서 보여지는 로그 데이터) / 오른 계단 공간(ex. M3_4), 오른 날짜 및 시간, 로그에서 보여지는 문자열 정보|
||reward_won|저감한 CO2 g수를 나타냄|
||stpes|오른 총 계단 수|
||this_month|이번 달 정보 / 어플을 실행하면, 이번 달 정보를 업데이트 함|
||this_month_steps|이번 달에 오른 계단 수|
||today|오늘 날짜 정보 / 어플을 실행하면, 오늘 날짜를 업데이트 함|
||||
|actions|bid|비콘 고유 번호 (beacon-id)|
||tag_time|비콘 태그 시간|
||uid|유저별 고유 번호 (user-id)|

### 로직 기록 데이터 및 판단 기준
계단을 의도한 방식으로 오르고 내린다는 것은 '수치를 올릴 목적으로, 계단에 계속 상주하고 있거나 계속 오르락 내리락 하는 행위'를 하지 않는 것을 의미함.  
따라서 아래와 같은 조건을 충족하도록 코드를 작성하였음.  
코드는 **lib > services > beacon_service.dart**에 작성되어 있음.  

    (1) 오늘 몇 층을 올랐는가?  
    (2) 이번 달에 몇 층을 올랐는가? (이달의 계단 랭킹)  
    (3) 계단을 올라 얼만큼의 CO2-eq를 배출하지 않았는가?  
    (4) 계단에 계속 상주하거나 오르락 내리락하지는 않았는가?  
    (5) actions 컬렉션에 데이터 추가  


#### (1) 오늘 몇 층을 올랐는가?  
어플을 실행하면, 오늘 날짜를 확인하고 **users > today**에 저장함.  
비콘이 태그되었을 때,    
(i) today가 이전에 저장된 today 값과 다르면, steps = 0으로 초기화  
(ii) today가 이전에 저장된 today 값과 같으면 steps = steps + 1 코드 동작 -> steps가 하나 오름.  
=> 홈화면의 오늘 오른 계단 수에 보여짐.  

#### (2) 이번 달에 몇 층을 올랐는가? (이달의 계단 랭킹)  
어플을 실행하면, 오늘 날짜를 확인하고 **users > this_month**에 Month/Year 정보를 저장함.  
비콘이 태그 되었을 때,  
(i) this_month가 이전에 저장된 this_month 값과 다르면, this_month_steps = 0으로 초기화  
(ii) this_month가 이전에 저장된 this_month 값과 같으면 this_month_steps = this_month_steps + 1 코드 동작  
=> 홈화면의 이번 달에 오른 계단 수에 보여지며, 이달의 계단 랭킹 순위에 반영됨.  

#### (3) 계단을 올라 얼만큼의 CO2-eq를 배출하지 않았는가?  
비콘이 태그 되었을 때,  
- **users > log_bottle** 로그 데이터에 비콘 이름(bid)과 날짜, '+2g CO2-Eq'라는 문자열이 등록됨.  
(계단 오르기가 아닌 경우, CO2-Eq의 양을 다르게 설정할 수 있음)  
- **users > reward_won**에 2가 더해짐.

#### (4) 계단에 계속 상주하거나 오르락 내리락하지는 않았는가?
비콘이 태그 되었을 때,  
* _beacons라는 임시 리스트에 비콘 정보(bid, tag_time, uid)를 저장함.
* 새로운 비콘 정보가 인식되었을 때, _beacons에 uid가 같은 것 중에, 새로운 비콘의 bid와 같은 bid의 비콘이 있는지 판단  
(i) bid와 일치하는 것이 존재할 경우, _beacons의 해당 비콘 tag_time과 새로운 비콘이 태깅된 시간 비교   
-> **3분 이내**면 제자리에 있거나 계속 오르락 내리락 한 것으로 간주 & _beacons 리스트에 새로 인식된 비콘 정보 업데이트  
-> **3분 이상**이면 올바르게 계단을 오른 것으로 간주. 위에서 언급한 (1)~(3) 수행.  
(ii) bid와 일치하는 것이 존재하지 않을 경우, _beacons에 새로운 비콘 정보 저장 & (1)~(3) 수행.  

#### (5) actions 컬렉션에 데이터 추가  
actions 컬렉션에 bid, tag_time, uid 추가  
